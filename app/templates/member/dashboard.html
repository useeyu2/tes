{% extends "base.html" %}

{% block title %}My Dashboard - Alumni Contribution{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-50">
    <!-- Mobile Sidebar trigger could go here -->

    <div class="flex-1 flex flex-col">
        <!-- Header -->
        <header class="bg-white shadow p-4 flex justify-between items-center z-10">
            <h1 class="text-xl font-bold text-primary">My Dashboard</h1>
            <div class="flex items-center gap-4">
                <a href="/welfare" class="text-sm text-gray-600 hover:text-primary font-medium">✨ Welfare & Support</a>
                <span id="userName" class="font-medium text-gray-700">Member</span>
                <button onclick="handleLogout()"
                    class="text-sm bg-gray-100 hover:bg-gray-200 px-3 py-2 rounded-lg transition">Logout</button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-4 md:p-8">
            <div class="max-w-5xl mx-auto space-y-8">

                <!-- Status Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <p class="text-sm text-gray-500 mb-1">Outstanding Balance</p>
                        <h3 class="text-3xl font-bold text-gray-900" id="totalDue">₦0.00</h3>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <p class="text-sm text-gray-500 mb-1">Status</p>
                        <span id="accountStatus"
                            class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            Active
                        </span>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <p class="text-sm text-gray-500 mb-1">My Score</p>
                        <div class="flex items-end items-baseline">
                            <h3 class="text-3xl font-bold text-gray-900" id="userScore">0</h3>
                            <span class="text-sm text-gray-400 ml-2">points</span>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-primary to-blue-600 text-white p-6 rounded-2xl shadow-lg transform transition hover:scale-[1.02] cursor-pointer"
                        onclick="openPaymentModal()">
                        <h3 class="text-xl font-bold mb-2">Make Payment</h3>
                        <p class="text-blue-100 text-sm">Pay dues or donate</p>
                    </div>
                </div>

                <!-- Contribution History -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                        <h2 class="text-lg font-bold text-gray-900">Contribution History</h2>
                        <select
                            class="text-sm border-gray-300 rounded-md shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50">
                            <option>2026</option>
                            <option>2025</option>
                        </select>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Month</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Due Date</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Amount</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Status</th>
                                    <th
                                        class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Action</th>
                                </tr>
                            </thead>
                            <tbody id="contributionsTable" class="bg-white divide-y divide-gray-200">
                                <!-- Loading state -->
                                <tr>
                                    <td colspan="5" class="px-6 py-4 text-center text-gray-500">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Simple Payment Modal -->
<div id="paymentModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Record Payment</h3>
            <div class="mt-4 text-left">
                <form id="paymentForm" class="space-y-4">
                    <input type="hidden" name="contribution_id" id="modalContributionId">

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Amount (₦)</label>
                        <input type="number" name="amount" id="modalAmount" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Method</label>
                        <select name="payment_method"
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Cash">Cash</option>
                            <!-- Online disabled for MVP Phase 1 basic -->
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Reference / Note</label>
                        <input type="text" name="reference_number" placeholder="Bank Ref No."
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                    </div>

                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" onclick="closePaymentModal()"
                            class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
                        <button type="submit"
                            class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-blue-800">Submit Proof</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    async function initDashboard() {
        const token = localStorage.getItem('access_token');
        if (!token) window.location.href = '/login';

        // Fetch User Details
        try {
            const res = await fetch('/api/v1/auth/me', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) {
                const user = await res.json();
                document.getElementById('userName').textContent = user.full_name;
                document.getElementById('userScore').textContent = user.contribution_score || 0;
            }
        } catch (e) { console.error(e); }

        // Fetch Contributions
        try {
            const res = await fetch('/api/v1/contributions/my-contributions', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();

            let totalDue = 0;
            const tbody = document.getElementById('contributionsTable');
            tbody.innerHTML = '';

            data.forEach(c => {
                const date = new Date(c.due_date).toLocaleDateString();
                const monthName = new Date(c.year, c.month - 1).toLocaleString('default', { month: 'long' });

                if (c.status === 'Pending' || c.status === 'Late') {
                    totalDue += (c.amount_due - c.amount_paid);
                }

                const statusColor = {
                    'Paid': 'bg-green-100 text-green-800',
                    'Pending': 'bg-yellow-100 text-yellow-800',
                    'Late': 'bg-red-100 text-red-800'
                }[c.status] || 'bg-gray-100 text-gray-800';

                tbody.innerHTML += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${monthName} ${c.year}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">₦${c.amount_due.toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                ${c.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            ${c.status !== 'Paid' ?
                        `<button onclick="openPaymentModal('${c._id}', ${c.amount_due})" class="text-primary hover:text-blue-900">Pay</button>` :
                        '<span class="text-green-600">✓</span>'}
                        </td>
                    </tr>
                `;
            });

            document.getElementById('totalDue').textContent = '₦' + totalDue.toLocaleString();

        } catch (e) {
            console.error(e);
        }
    }

    // Modal Logic
    function openPaymentModal(contributionId = null, amount = '') {
        document.getElementById('paymentModal').classList.remove('hidden');
        document.getElementById('modalContributionId').value = contributionId || '';
        document.getElementById('modalAmount').value = amount || '';
    }

    function closePaymentModal() {
        document.getElementById('paymentModal').classList.add('hidden');
    }

    document.getElementById('paymentForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        data.amount = parseFloat(data.amount);

        const token = localStorage.getItem('access_token');

        try {
            const res = await fetch('/api/v1/contributions/pay', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                alert('Payment proof submitted successfully! Waiting for admin verification.');
                closePaymentModal();
                initDashboard(); // Refresh
            } else {
                alert('Failed to submit payment.');
            }
        } catch (err) {
            console.error(err);
        }
    });

    initDashboard();
</script>
{% endblock %}