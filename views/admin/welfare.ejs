<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Welfare - Alumni System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { theme: { extend: { colors: { primary: '#1e3a8a', secondary: '#1e40af' } } } }
    </script>
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .bg-pattern {
            background-image: radial-gradient(#1e3a8a 0.5px, transparent 0.5px);
            background-size: 20px 20px;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900 bg-pattern min-h-screen">
    <div class="flex h-screen overflow-hidden relative">
        <%- include('../partials/sidebar') %>

            <!-- Main Content -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <%- include('../partials/header', { title: 'Welfare Requests' }) %>

                    <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
                        <div class="bg-white rounded-xl shadow p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4 uppercase tracking-tight">Pending Review
                            </h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-black text-gray-400 uppercase tracking-widest">
                                                Member
                                            </th>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-black text-gray-400 uppercase tracking-widest">
                                                Type
                                            </th>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-black text-gray-400 uppercase tracking-widest">
                                                Description</th>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-black text-gray-400 uppercase tracking-widest">
                                                Amount
                                            </th>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-black text-gray-400 uppercase tracking-widest">
                                                Status
                                            </th>
                                            <th
                                                class="px-6 py-3 text-right text-xs font-black text-gray-400 uppercase tracking-widest">
                                                Actions
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="welfareTable" class="bg-white divide-y divide-gray-200">
                                        <tr>
                                            <td colspan="6" class="px-6 py-4 text-center text-gray-500 font-medium">
                                                Loading requests...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </main>
            </div>
    </div>

    <!-- Welfare Action Modal -->
    <div id="welfareModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-[100] p-4">
        <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-lg p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-black text-gray-900" id="modalTitle">Review Request</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <form id="welfareForm" class="space-y-4">
                <div id="statusSection">
                    <label class="block text-xs font-black text-gray-400 uppercase tracking-widest mb-1">Update
                        Status</label>
                    <select id="status"
                        class="w-full px-5 py-3 bg-gray-50 border border-gray-100 rounded-xl focus:ring-4 focus:ring-primary/10 font-bold">
                        <option value="Pending">Pending</option>
                        <option value="Under Review">Under Review</option>
                        <option value="Approved">Approved</option>
                        <option value="Rejected">Rejected</option>
                        <option value="Disbursed">Disbursed</option>
                    </select>
                </div>

                <div id="detailsSection" class="hidden space-y-4">
                    <div>
                        <label class="block text-xs font-black text-gray-400 uppercase tracking-widest mb-1">Amount
                            (₦)</label>
                        <input type="number" id="amount"
                            class="w-full px-5 py-3 bg-gray-50 border border-gray-100 rounded-xl focus:ring-4 focus:ring-primary/10 font-bold">
                    </div>
                    <div>
                        <label
                            class="block text-xs font-black text-gray-400 uppercase tracking-widest mb-1">Type</label>
                        <select id="request_type"
                            class="w-full px-5 py-3 bg-gray-50 border border-gray-100 rounded-xl focus:ring-4 focus:ring-primary/10 font-bold">
                            <option value="Medical Emergency">Medical Emergency</option>
                            <option value="Bereavement">Bereavement</option>
                            <option value="Wedding">Wedding</option>
                            <option value="Job Loss">Job Loss</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-black text-gray-400 uppercase tracking-widest mb-1"
                        id="commentsLabel">Admin Comments</label>
                    <textarea id="description" rows="3"
                        class="w-full px-5 py-3 bg-gray-50 border border-gray-100 rounded-xl focus:ring-4 focus:ring-primary/10 font-bold"></textarea>
                </div>

                <button type="submit"
                    class="w-full bg-primary text-white py-4 rounded-xl font-black hover:bg-blue-800 transition shadow-lg shadow-blue-500/20 uppercase tracking-widest">
                    SAVE CHANGES
                </button>
            </form>
        </div>
    </div>

    <script>
        let allRequests = [];

        async function loadAllRequests() {
            const token = localStorage.getItem('access_token');
            if (!token) return;
            try {
                const res = await fetch('/api/v1/welfare/all', { headers: { 'Authorization': `Bearer ${token}` } });
                if (res.ok) {
                    const result = await res.json();
                    const data = result.data || [];
                    const tbody = document.getElementById('welfareTable');
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-400 font-medium">No welfare requests found.</td></tr>';
                        return;
                    }

                    tbody.innerHTML = data.map(r => `
                        <tr class="hover:bg-gray-50 transition border-b border-gray-50 last:border-0">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">${r.user_name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-medium">${r.request_type}</td>
                            <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate font-medium" title="${r.description}">${r.description}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-black text-gray-900">₦${r.amount_requested.toLocaleString()}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 rounded-lg text-[10px] font-black uppercase tracking-widest ${r.status === 'Approved' ? 'bg-green-100 text-green-700' :
                            r.status === 'Rejected' ? 'bg-red-100 text-red-700' :
                                r.status === 'Disbursed' ? 'bg-blue-100 text-blue-700' : 'bg-orange-100 text-orange-700'
                        }">${r.status}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right space-x-2">
                                <button onclick="openReviewModal('${r._id}')" class="p-2 text-primary hover:bg-blue-50 rounded-lg transition" title="Review">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                </button>
                                <button onclick="openEditModal('${r._id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition" title="Edit Details">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                </button>
                                <button onclick="deleteRequest('${r._id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition" title="Delete">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </td>
                        </tr>
                    `).join('');

                    allRequests = data;
                }
            } catch (e) { console.error(e); }
        }

        function closeModal() {
            document.getElementById('welfareModal').classList.add('hidden');
            document.getElementById('welfareModal').classList.remove('flex');
            document.getElementById('welfareForm').reset();
            document.getElementById('welfareForm').removeAttribute('data-id');
            document.getElementById('welfareForm').removeAttribute('data-mode');
        }

        function openReviewModal(id) {
            const req = allRequests.find(r => r._id === id);
            if (!req) return;

            document.getElementById('modalTitle').textContent = 'Review Request';
            document.getElementById('statusSection').classList.remove('hidden');
            document.getElementById('detailsSection').classList.add('hidden');
            document.getElementById('commentsLabel').textContent = 'Admin Comments';
            document.getElementById('status').value = req.status;
            document.getElementById('description').value = ''; // Clear for new comment

            document.getElementById('welfareForm').setAttribute('data-id', id);
            document.getElementById('welfareForm').setAttribute('data-mode', 'review');
            document.getElementById('welfareModal').classList.remove('hidden');
            document.getElementById('welfareModal').classList.add('flex');
        }

        function openEditModal(id) {
            const req = allRequests.find(r => r._id === id);
            if (!req) return;

            document.getElementById('modalTitle').textContent = 'Edit Details';
            document.getElementById('statusSection').classList.add('hidden');
            document.getElementById('detailsSection').classList.remove('hidden');
            document.getElementById('commentsLabel').textContent = 'Request Description';
            document.getElementById('amount').value = req.amount_requested;
            document.getElementById('request_type').value = req.request_type;
            document.getElementById('description').value = req.description;

            document.getElementById('welfareForm').setAttribute('data-id', id);
            document.getElementById('welfareForm').setAttribute('data-mode', 'edit');
            document.getElementById('welfareModal').classList.remove('hidden');
            document.getElementById('welfareModal').classList.add('flex');
        }

        document.getElementById('welfareForm').onsubmit = async (e) => {
            e.preventDefault();
            const id = e.target.getAttribute('data-id');
            const mode = e.target.getAttribute('data-mode');
            const token = localStorage.getItem('access_token');

            let url = `/api/v1/welfare/${id}`;
            let method = 'PUT';
            let data = {};

            if (mode === 'review') {
                url += '/status';
                method = 'PATCH';
                data = {
                    status: document.getElementById('status').value,
                    admin_comments: document.getElementById('description').value
                };
            } else {
                data = {
                    amount_requested: document.getElementById('amount').value,
                    request_type: document.getElementById('request_type').value,
                    description: document.getElementById('description').value
                };
            }

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) { closeModal(); loadAllRequests(); }
                else { alert('Failed to update request'); }
            } catch (err) { console.error(err); }
        };

        async function deleteRequest(id) {
            if (!confirm('Are you sure you want to delete this welfare request?')) return;
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`/api/v1/welfare/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) loadAllRequests();
                else alert('Failed to delete request');
            } catch (err) { console.error(err); }
        }
        loadAllRequests();
    </script>
</body>

</html>