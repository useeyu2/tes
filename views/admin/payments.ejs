<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Payments - Alumni System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { theme: { extend: { colors: { primary: '#1e3a8a', secondary: '#1e40af' } } } }
    </script>
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .bg-pattern {
            background-image: radial-gradient(#1e3a8a 0.5px, transparent 0.5px);
            background-size: 20px 20px;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900 bg-pattern min-h-screen">
    <div class="flex h-screen overflow-hidden relative">
        <div class="flex h-screen overflow-hidden relative">
            <%- include('../partials/sidebar') %>

                <!-- Main Content -->
                <div class="flex-1 flex flex-col overflow-hidden">
                    <% const actions=` <button onclick="triggerMonthly()"
                        class="bg-green-600 text-white p-2 md:px-4 md:py-2 rounded-lg text-sm hover:bg-green-700 shadow">
                        <span class="hidden md:inline">Generate Monthly Dues</span>
                        <span class="md:hidden">üìÖ</span>
                        </button>
                        <button onclick="handleLogout()"
                            class="bg-red-500 hover:bg-red-600 text-white p-2 md:px-4 md:py-2 rounded-lg text-sm font-bold transition">
                            <span class="hidden md:inline">Logout</span>
                            <span class="md:hidden">üö™</span>
                        </button>
                        `; %>
                        <%- include('../partials/header', { title: 'Payments Management' , actions: actions }) %>

                            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
                                <div class="bg-white rounded-xl shadow p-6">
                                    <h3 class="text-lg font-bold text-gray-800 mb-4">Pending Verifications</h3>
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th
                                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                        User
                                                    </th>
                                                    <th
                                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                        Amount
                                                    </th>
                                                    <th
                                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                        Method
                                                    </th>
                                                    <th
                                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                        Ref</th>
                                                    <th
                                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                        Proof
                                                    </th>
                                                    <th
                                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                        Date
                                                    </th>
                                                    <th
                                                        class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">
                                                        Actions
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody id="transactionsTable" class="bg-white divide-y divide-gray-200">
                                                <tr>
                                                    <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                                        Loading...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Recent Transactions (Audit/Undo) -->
                                <div class="bg-white rounded-xl shadow p-6 mt-8">
                                    <div class="flex justify-between items-center mb-4">
                                        <h3 class="text-lg font-bold text-gray-800">Processed Transactions</h3>
                                        <p class="text-[10px] uppercase font-bold text-gray-400">Allows Reverting
                                            Approval/Rejection</p>
                                    </div>
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th
                                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                        User
                                                    </th>
                                                    <th
                                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                        Amount
                                                    </th>
                                                    <th
                                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                        Status
                                                    </th>
                                                    <th
                                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                        Date
                                                    </th>
                                                    <th
                                                        class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">
                                                        Actions
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody id="recentTransactionsTable"
                                                class="bg-white divide-y divide-gray-200">
                                                <tr>
                                                    <td colspan="5" class="px-6 py-4 text-center text-gray-500">Loading
                                                        history...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </main>
                </div>

                <!-- Proof View Modal -->
                <div id="proofModal"
                    class="fixed inset-0 bg-black/80 backdrop-blur-md hidden items-center justify-center z-[100] p-4">
                    <div
                        class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                            <h3 class="text-lg font-bold text-gray-800">Payment Proof</h3>
                            <button onclick="closeProofModal()" class="text-gray-400 hover:text-gray-600 transition">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="flex-1 overflow-auto bg-gray-50 flex items-center justify-center p-4"
                            id="proofContainer">
                            <!-- Content injected here -->
                        </div>
                    </div>
                </div>
        </div>

        <script>
            function viewProof(url) {
                const container = document.getElementById('proofContainer');
                if (url.toLowerCase().endsWith('.pdf')) {
                    container.innerHTML = `<iframe src="${url}" class="w-full h-[70vh] rounded-lg shadow-inner"></iframe>`;
                } else {
                    container.innerHTML = `<img src="${url}" class="max-w-full max-h-[70vh] rounded-lg shadow-lg" />`;
                }
                document.getElementById('proofModal').classList.remove('hidden');
                document.getElementById('proofModal').classList.add('flex');
            }

            function closeProofModal() {
                document.getElementById('proofModal').classList.add('hidden');
                document.getElementById('proofModal').classList.remove('flex');
                document.getElementById('proofContainer').innerHTML = '';
            }

            async function loadPendingPayments() {
                const token = localStorage.getItem('access_token');
                try {
                    const res = await fetch('/api/v1/admin/transactions?status=Pending', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (res.ok) {
                        const result = await res.json();
                        const txs = result.data || [];
                        const tbody = document.getElementById('transactionsTable');

                        if (txs.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No pending payments found.</td></tr>';
                            return;
                        }

                        tbody.innerHTML = txs.map(tx => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${tx.user_email}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">‚Ç¶${tx.amount.toLocaleString()}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${tx.payment_method}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${tx.reference_number || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                ${tx.proof_url ? `<button onclick="viewProof('${tx.proof_url}')" class="text-blue-600 font-bold hover:underline">üìÑ View Proof</button>` : '<span class="text-gray-300 italic">No Proof</span>'}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(tx.created_at).toLocaleDateString()}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                <button onclick="verifyPayment('${tx._id}', 'Verified')" class="text-green-600 hover:text-green-900 font-bold">Approve</button>
                                <button onclick="verifyPayment('${tx._id}', 'Rejected')" class="text-red-600 hover:text-red-900 font-bold">Reject</button>
                            </td>
                        </tr>
                    `).join('');
                    }
                } catch (e) { console.error(e); }
            }

            async function verifyPayment(id, status) {
                if (!confirm(`Are you sure you want to mark this as ${status}?`)) return;
                const token = localStorage.getItem('access_token');
                try {
                    const res = await fetch(`/api/v1/contributions/verify-payment/${id}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ status })
                    });
                    const result = await res.json();
                    if (result.success) {
                        alert(result.message || `Payment ${status}`);
                        loadPendingPayments();
                        loadRecentPayments();
                    } else {
                        alert(result.message || "Action failed.");
                    }
                } catch (e) { console.error(e); }
            }

            async function loadRecentPayments() {
                const token = localStorage.getItem('access_token');
                try {
                    const res = await fetch('/api/v1/admin/transactions', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (res.ok) {
                        const result = await res.json();
                        const txs = (result.data || []).filter(t => t.status !== 'Pending');
                        const tbody = document.getElementById('recentTransactionsTable');

                        if (txs.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No processed payments found.</td></tr>';
                            return;
                        }

                        tbody.innerHTML = txs.map(tx => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${tx.user_email}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">‚Ç¶${tx.amount.toLocaleString()}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-0.5 text-[10px] font-bold uppercase rounded ${tx.status === 'Verified' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                    ${tx.status}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(tx.created_at).toLocaleDateString()}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-3">
                                ${tx.proof_url ? `<button onclick="viewProof('${tx.proof_url}')" class="text-blue-600 font-bold hover:underline">üìÑ View Proof</button>` : '<span class="text-gray-300 italic">No Proof</span>'}
                                <button onclick="revertPayment('${tx._id}')" class="text-indigo-600 hover:text-indigo-900 font-bold">Revert to Pending</button>
                                ${tx.status === 'Rejected' ? `<button onclick="deleteTransaction('${tx._id}')" class="text-red-600 hover:text-red-900 font-bold">Delete</button>` : ''}
                            </td>
                        </tr>
                    `).join('');
                    }
                } catch (e) { console.error(e); }
            }

            async function revertPayment(id) {
                if (!confirm("Are you sure you want to revert this to Pending? Points and status will be updated accordingly.")) return;
                const token = localStorage.getItem('access_token');
                try {
                    const res = await fetch(`/api/v1/contributions/revert-payment/${id}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await res.json();
                    if (result.success) {
                        alert(result.message || "Payment reverted to pending.");
                        loadPendingPayments();
                        loadRecentPayments();
                    } else {
                        alert(result.message || "Revert failed.");
                    }
                } catch (e) { console.error(e); }
            }

            async function deleteTransaction(id) {
                if (!confirm("‚ö†Ô∏è WARNING: This will PERMANENTLY DELETE this rejected transaction.\n\nThis action CANNOT be undone!\n\nAre you sure?")) return;
                const token = localStorage.getItem('access_token');
                try {
                    const res = await fetch(`/api/v1/admin/transactions/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await res.json();
                    if (result.success) {
                        alert(result.message || "Transaction deleted successfully.");
                        loadRecentPayments();
                    } else {
                        alert(result.detail || result.message || "Delete failed.");
                    }
                } catch (e) {
                    console.error(e);
                    alert('An error occurred while deleting the transaction.');
                }
            }

            async function triggerMonthly() {
                if (!confirm("Generate monthly dues for all active members (‚Ç¶1,000 each)?")) return;
                const token = localStorage.getItem('access_token');
                try {
                    const res = await fetch('/api/v1/contributions/generate-monthly', { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
                    const result = await res.json();
                    if (result.success) {
                        alert(result.message || "Monthly dues generated!");
                    } else {
                        alert(result.message || "Failed to generate dues.");
                    }
                } catch (e) { console.error(e); }
            }

            loadPendingPayments();
            loadRecentPayments();
        </script>
</body>

</html>