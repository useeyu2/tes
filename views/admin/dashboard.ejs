<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Members - Alumni System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { theme: { extend: { colors: { primary: '#1e3a8a', secondary: '#1e40af' } } } }
    </script>
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .bg-pattern {
            background-image: radial-gradient(#1e3a8a 0.5px, transparent 0.5px);
            background-size: 20px 20px;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900 bg-pattern min-h-screen">
    <div class="flex h-screen overflow-hidden relative">
        <%- include('../partials/sidebar') %>

            <!-- Main Content -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <% const actions=` <button onclick="openAddMemberModal()"
                    class="bg-primary text-white p-2 md:px-4 md:py-2 rounded-lg text-sm hover:bg-blue-800 transition shadow-lg shadow-blue-500/20">
                    <span class="hidden md:inline">Add Member</span>
                    <span class="md:hidden">‚ûï</span>
                    </button>
                    <button onclick="exportToCSV()"
                        class="border border-gray-300 text-gray-700 p-2 md:px-4 md:py-2 rounded-lg text-sm hover:bg-gray-50 transition">
                        <span class="hidden md:inline">Export CSV</span>
                        <span class="md:hidden">üì•</span>
                    </button>
                    `;
                    %>
                    <%- include('../partials/header', { title: 'Admin Dashboard' , actions: actions }) %>


                        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
                            <!-- Stats Row -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-4 mb-6">
                                <!-- Cards -->
                                <div class="bg-white rounded-xl shadow p-4 border-l-4 border-blue-500">
                                    <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Total
                                        Members</p>
                                    <div class="flex justify-between items-center mt-1">
                                        <h3 class="text-xl font-black text-gray-800" id="totalMembers">0</h3>
                                        <span class="text-xl opacity-50">üë•</span>
                                    </div>
                                </div>

                                <div class="bg-white rounded-xl shadow p-4 border-l-4 border-green-500">
                                    <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Raised
                                        (Annual)</p>
                                    <div class="flex justify-between items-center mt-1">
                                        <h3 class="text-xl font-black text-green-600" id="annualTotal">‚Ç¶0</h3>
                                        <span class="text-xl opacity-50">üí∞</span>
                                    </div>
                                </div>

                                <div class="bg-white rounded-xl shadow p-4 border-l-4 border-red-500">
                                    <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Expenses</p>
                                    <div class="flex justify-between items-center mt-1">
                                        <h3 class="text-xl font-black text-red-600" id="annualExpenses">‚Ç¶0</h3>
                                        <span class="text-xl opacity-50">üìâ</span>
                                    </div>
                                </div>

                                <div class="bg-white rounded-xl shadow p-4 border-l-4 border-cyan-500">
                                    <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Balance</p>
                                    <div class="flex justify-between items-center mt-1">
                                        <h3 class="text-xl font-black text-blue-600" id="balance">‚Ç¶0</h3>
                                        <span class="text-xl opacity-50">‚öñÔ∏è</span>
                                    </div>
                                </div>

                                <div class="bg-white rounded-xl shadow p-4 border-l-4 border-purple-500">
                                    <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Collected
                                        (Month)</p>
                                    <div class="flex justify-between items-center mt-1">
                                        <h3 class="text-xl font-black text-purple-600" id="monthlyCollected">‚Ç¶0</h3>
                                        <span class="text-xl opacity-50">üìà</span>
                                    </div>
                                </div>

                                <div class="bg-white rounded-xl shadow p-4 border-l-4 border-orange-500">
                                    <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Pending
                                        (Month)</p>
                                    <div class="flex justify-between items-center mt-1">
                                        <h3 class="text-xl font-black text-orange-600" id="monthlyPending">‚Ç¶0</h3>
                                        <span class="text-xl opacity-50">‚è≥</span>
                                    </div>
                                </div>

                                <div class="bg-white rounded-xl shadow p-4 border-l-4 border-yellow-500">
                                    <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Approvals
                                    </p>
                                    <div class="flex justify-between items-center mt-1">
                                        <h3 class="text-xl font-black text-yellow-600" id="pendingApprovals">0</h3>
                                        <span class="text-xl opacity-50">üîî</span>
                                    </div>
                                </div>

                                <div class="bg-white rounded-xl shadow p-4 border-l-4 border-rose-500">
                                    <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Messages</p>
                                    <div class="flex justify-between items-center mt-1">
                                        <h3 class="text-xl font-black text-rose-600" id="unreadMessages">0</h3>
                                        <span class="text-xl opacity-50">üí¨</span>
                                    </div>
                                </div>

                                <div class="bg-white rounded-xl shadow p-4 border-l-4 border-indigo-500">
                                    <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Welfare</p>
                                    <div class="flex justify-between items-center mt-1">
                                        <h3 class="text-xl font-black text-indigo-600" id="pendingWelfare">0</h3>
                                        <span class="text-xl opacity-50">üè•</span>
                                    </div>
                                </div>

                                <div class="bg-white rounded-xl shadow p-4 border-l-4 border-emerald-500">
                                    <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Events</p>
                                    <div class="flex justify-between items-center mt-1">
                                        <h3 class="text-xl font-black text-emerald-600" id="upcomingEvents">0</h3>
                                        <span class="text-xl opacity-50">üìÖ</span>
                                    </div>
                                </div>
                            </div>

                            <div
                                class="bg-blue-50 border border-blue-100 p-4 rounded-xl mb-6 flex flex-col md:flex-row items-center justify-between gap-4">
                                <div class="text-center md:text-left">
                                    <h4 class="text-blue-800 font-bold">System Status: Active</h4>
                                    <p class="text-blue-600 text-sm">Monthly contribution set to ‚Ç¶1,000 per member.</p>
                                </div>
                                <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
                                    <button onclick="triggerMonthly()"
                                        class="bg-primary text-white px-4 py-3 md:py-2 rounded-lg text-sm hover:bg-blue-800 shadow-md transform active:scale-95 transition font-bold w-full sm:w-auto">
                                        üîÑ Generate Monthly Dues
                                    </button>
                                    <button onclick="sendReminders()"
                                        class="bg-orange-600 text-white px-4 py-3 md:py-2 rounded-lg text-sm hover:bg-orange-700 shadow-md transform active:scale-95 transition font-bold w-full sm:w-auto">
                                        üîî Send Reminders
                                    </button>
                                </div>
                            </div>

                            <!-- Recent Activity Widgets -->
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                                <!-- Recent Welfare -->
                                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                                    <div
                                        class="px-6 py-4 border-b border-gray-50 flex justify-between items-center bg-gray-50/50">
                                        <h4 class="text-xs font-black text-gray-400 uppercase tracking-widest">Recent
                                            Welfare</h4>
                                        <a href="/admin/welfare"
                                            class="text-[10px] font-bold text-primary hover:underline">View
                                            All</a>
                                    </div>
                                    <div id="recentWelfareList" class="divide-y divide-gray-50">
                                        <div class="p-6 text-center text-gray-400 text-xs italic">Loading...</div>
                                    </div>
                                </div>

                                <!-- Recent Expenses -->
                                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                                    <div
                                        class="px-6 py-4 border-b border-gray-50 flex justify-between items-center bg-gray-50/50">
                                        <h4 class="text-xs font-black text-gray-400 uppercase tracking-widest">Recent
                                            Expenses</h4>
                                        <a href="/admin/expenses"
                                            class="text-[10px] font-bold text-primary hover:underline">View
                                            All</a>
                                    </div>
                                    <div id="recentExpensesList" class="divide-y divide-gray-50">
                                        <div class="p-6 text-center text-gray-400 text-xs italic">Loading...</div>
                                    </div>
                                </div>

                                <!-- Upcoming Events -->
                                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                                    <div
                                        class="px-6 py-4 border-b border-gray-50 flex justify-between items-center bg-gray-50/50">
                                        <h4 class="text-xs font-black text-gray-400 uppercase tracking-widest">Upcoming
                                            Events</h4>
                                        <a href="/admin/events/create"
                                            class="text-[10px] font-bold text-primary hover:underline">Manage</a>
                                    </div>
                                    <div id="upcomingEventsList" class="divide-y divide-gray-50">
                                        <div class="p-6 text-center text-gray-400 text-xs italic">Loading...</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Pending Approvals Section -->
                            <div id="pendingSection" class="bg-white rounded-xl shadow mb-6 hidden">
                                <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                                    <h3 class="text-lg font-bold text-gray-800">‚è≥ Pending Approvals</h3>
                                    <span class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-sm font-bold"
                                        id="pendingBadge">0 pending</span>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-yellow-50">
                                            <tr>
                                                <th
                                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                    Name
                                                </th>
                                                <th
                                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                    Email
                                                </th>
                                                <th
                                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                    Username
                                                </th>
                                                <th
                                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                    Phone
                                                </th>
                                                <th
                                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                    Registered</th>
                                                <th
                                                    class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">
                                                    Action
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="pendingTable" class="bg-white divide-y divide-gray-200">
                                            <tr>
                                                <td colspan="6" class="px-6 py-4 text-center text-gray-500">No pending
                                                    approvals
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Members Table -->
                            <div class="bg-white rounded-xl shadow">
                                <div class="px-6 py-4 border-b border-gray-100">
                                    <h3 class="text-lg font-bold text-gray-800">Registered Alumni</h3>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th
                                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                    Name
                                                </th>
                                                <th
                                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                    Email
                                                </th>
                                                <th
                                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                    Role
                                                </th>
                                                <th
                                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                    Status
                                                </th>
                                                <th
                                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                    Score
                                                </th>
                                                <th
                                                    class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">
                                                    Actions
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="membersTable" class="bg-white divide-y divide-gray-200">
                                            <tr>
                                                <td colspan="6" class="px-6 py-4 text-center text-gray-500">Loading...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </main>
            </div>
    </div>

    <!-- Edit Role Modal -->
    <div id="editModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 transform transition-all">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Edit Member Role</h3>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <div class="space-y-4">
                <div>
                    <p class="text-sm text-gray-500 font-medium mb-1">Member Name</p>
                    <p id="editMemberName" class="text-lg font-bold text-gray-800"></p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select New Role</label>
                    <select id="editRoleSelect"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition">
                        <option value="Member">Member</option>
                        <option value="Admin">Admin</option>
                        <option value="SuperAdmin">Super Admin</option>
                    </select>

                </div>
            </div>

            <div class="flex gap-3 mt-8">
                <button onclick="closeEditModal()"
                    class="flex-1 px-4 py-3 border border-gray-300 rounded-lg text-gray-700 font-bold hover:bg-gray-50 transition">
                    Cancel
                </button>
                <button onclick="saveRoleChange()"
                    class="flex-1 px-4 py-3 bg-primary rounded-lg text-white font-bold hover:bg-blue-800 transition shadow-lg">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Add Member Modal -->
    <div id="addMemberModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-8 transform transition-all">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Add New Member</h3>
                <button onclick="closeAddMemberModal()" class="text-gray-400 hover:text-gray-600 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <form id="addMemberForm" onsubmit="submitAddMember(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                    <input type="text" id="addFullName" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <input type="text" id="addUsername" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="addEmail" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                        <input type="tel" id="addPhone" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="addPassword" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition">
                </div>

                <div class="flex gap-3 mt-8">
                    <button type="button" onclick="closeAddMemberModal()"
                        class="flex-1 px-4 py-3 border border-gray-300 rounded-lg text-gray-700 font-bold hover:bg-gray-50 transition">
                        Cancel
                    </button>
                    <button type="submit"
                        class="flex-1 px-4 py-3 bg-primary rounded-lg text-white font-bold hover:bg-blue-800 transition shadow-lg">
                        Add Member
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('adminSidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        // Global store for members
        let allMembers = [];

        async function handleLogout() { localStorage.removeItem('access_token'); window.location.href = '/login'; }

        async function fetchMembers() {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch('/api/v1/admin/members', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const result = await res.json();
                    allMembers = result.data || [];
                    document.getElementById('totalMembers').textContent = allMembers.length;

                    const tbody = document.getElementById('membersTable');
                    tbody.innerHTML = allMembers.map(m => `
    <tr class="${!m.is_active ? 'bg-gray-50 opacity-75' : ''}">
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${m.full_name}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${m.email}</td>
        <td class="px-6 py-4 whitespace-nowrap">
            <span
                class="px-3 py-1 text-[10px] font-black uppercase tracking-widest rounded-lg bg-blue-100 text-blue-800">${m.role}</span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
            <span
                class="px-3 py-1 text-[10px] font-black uppercase tracking-widest rounded-lg ${m.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                ${m.is_active ? 'Active' : 'Deactivated'}
            </span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-bold">${m.contribution_score || 0}</td>
        <td class="px-6 py-4 whitespace-nowrap text-right text-sm space-x-3">
            <button onclick="openDetailsModal('${m._id}')"
                class="text-secondary font-bold hover:underline">View</button>
            <button onclick="openEditModal('${m._id}', '${m.role}', '${m.full_name.replace(/'/g, "\\'")}')"
                class="text-primary font-bold hover:underline">Edit</button>
            <button onclick="toggleMemberStatus('${m._id}', ${m.is_active}, '${m.full_name.replace(/'/g, "\\'")}')"
                class="${m.is_active ? 'text-red-500' : 'text-green-500'} font-bold hover:underline">
                ${m.is_active ? 'Deactivate' : 'Reactivate'}
            </button>
            <button onclick="deleteMember('${m._id}', '${m.full_name.replace(/'/g, "\'")}')"
                class="text-gray-600 font-bold hover:underline hover:text-red-700" >
                        Delete
            </button>
        </td>
    </tr>
                        `).join('');
                }
            } catch (e) { console.error(e); }
        }

        // Member Details Modal
        function openDetailsModal(userId) {
            const member = allMembers.find(m => m._id === userId);
            if (!member) return;

            const modalHtml = `
                <div id="detailsModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[60]">
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-8 transform transition-all">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold text-gray-800">Member Details</h3>
                            <button onclick="closeDetailsModal()" class="text-gray-400 hover:text-gray-600 transition">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                                    </path>
                                </svg>
                            </button>
                        </div>
                        <div class="grid grid-cols-2 gap-6 text-sm">
                            <div>
                                <p class="text-gray-500 font-medium">Full Name</p>
                                <p class="text-lg font-bold text-gray-900">${member.full_name}</p>
                            </div>
                            <div>
                                <p class="text-gray-500 font-medium">Username</p>
                                <p class="font-bold text-gray-800">${member.username || '-'}</p>
                            </div>
                            <div class="col-span-2">
                                <p class="text-gray-500 font-medium">Email Address</p>
                                <p class="font-bold text-gray-800">${member.email}</p>
                            </div>
                            <div>
                                <p class="text-gray-500 font-medium">Phone Number</p>
                                <p class="font-bold text-gray-800">${member.phone || '-'}</p>
                            </div>
                            <div>
                                <p class="text-gray-500 font-medium">Graduation Year</p>
                                <p class="font-bold text-gray-800">${member.graduation_year || '-'}</p>
                            </div>
                            <div>
                                <p class="text-gray-500 font-medium">Role</p>
                                <span
                                    class="px-3 py-1 text-[10px] font-black uppercase tracking-widest rounded-lg bg-blue-100 text-blue-800">${member.role}</span>
                            </div>
                            <div>
                                <p class="text-gray-500 font-medium">Status</p>
                                <span
                                    class="px-3 py-1 text-[10px] font-black uppercase tracking-widest rounded-lg ${member.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${member.is_active ? 'Active' : 'Deactivated'}
                                </span>
                            </div>
                            <div>
                                <p class="text-gray-500 font-medium">Contribution Score</p>
                                <p class="font-bold text-gray-900">${member.contribution_score || 0} pts</p>
                            </div>
                            <div>
                                <p class="text-gray-500 font-medium">Joined On</p>
                                <p class="font-bold text-gray-800">${new Date(member.created_at).toLocaleDateString()}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeDetailsModal() {
            const modal = document.getElementById('detailsModal');
            if (modal) modal.remove();
        }

        // Reset Password Modal
        function openResetPasswordModal(userId, fullName) {
            closeDetailsModal();
            const modalHtml = `
                <div id="resetPasswordModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[70]">
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 transform transition-all">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold text-gray-800">Reset Password</h3>
                            <button onclick="closeResetPasswordModal()" class="text-gray-400 hover:text-gray-600 transition">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                                    </path>
                                </svg>
                            </button>
                        </div>
                        <p class="text-sm text-gray-500 mb-6">Set a new password for <span
                            class="font-bold text-gray-800">${fullName}</span>.</p>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">New Password</label>
                                <input type="password" id="newPassword" placeholder="Minimum 6 characters"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Confirm New Password</label>
                                <input type="password" id="confirmPassword"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition">
                            </div>
                        </div>
                        <div class="flex gap-3 mt-8">
                            <button onclick="closeResetPasswordModal()"
                                class="flex-1 px-4 py-3 border border-gray-300 rounded-lg text-gray-700 font-bold hover:bg-gray-50 transition">
                                Cancel
                            </button>
                            <button onclick="submitPasswordReset('${userId}')"
                                class="flex-1 px-4 py-3 bg-red-600 rounded-lg text-white font-bold hover:bg-red-700 transition shadow-lg">
                                Reset Password
                            </button>
                        </div>
                    </div>
                </div>
                `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeResetPasswordModal() {
            const modal = document.getElementById('resetPasswordModal');
            if (modal) modal.remove();
        }

        async function submitPasswordReset(userId) {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword.length < 6) return alert('Password must be at least 6 characters long');
            if (newPassword !== confirmPassword) return alert('Passwords do not match');

            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`/api/v1/admin/members/${userId}/reset-password`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ newPassword })
                });

                if (res.ok) {
                    const result = await res.json();
                    alert(result.message || 'Password reset successfully!');
                    closeResetPasswordModal();
                } else {
                    const text = await res.text();
                    console.error('Server error response:', text);
                    try {
                        const error = JSON.parse(text);
                        alert(error.detail || 'Failed to reset password');
                    } catch (e) {
                        alert(`Server Error (${res.status}): ${text.substring(0, 100)}`);
                    }
                }
            } catch (e) {
                console.error('Fetch error:', e);
                alert(`Connection Error: ${e.message}`);
            }
        }
        async function toggleMemberStatus(userId, currentIsActive, fullName) {
            const action = currentIsActive ? 'deactivate' : 'reactivate';
            if (!confirm(`Are you sure you want to ${action} ${fullName}?`)) return;

            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`/api/v1/admin/members/${userId}/status`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: !currentIsActive })
                });

                if (res.ok) {
                    alert(`${fullName} has been ${action}d!`);
                    fetchMembers();
                } else {
                    const error = await res.json();
                    alert(error.detail || `Failed to ${action} user`);
                }
            } catch (e) {
                console.error(e);
                alert('An error occurred: ' + (e.message || 'Unknown error'));
            }
        }

        async function deleteMember(userId, fullName) {
            if (!confirm(`‚ö†Ô∏è WARNING: This will PERMANENTLY DELETE ${fullName} from the system.\n\nThis action CANNOT be undone!\n\nAre you absolutely sure ?`)) return;

            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`/api/v1/admin/members/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (res.ok) {
                    alert(`${fullName} has been permanently deleted!`);
                    fetchMembers();
                } else {
                    const error = await res.json();
                    alert(error.detail || 'Failed to delete user');
                }
            } catch (e) {
                console.error(e);
                alert('An error occurred: ' + (e.message || 'Unknown error'));
            }
        } async function fetchStats() {
            const token = localStorage.getItem('access_token'); try { // Monthly Summary
                const resMonthly = await fetch('/api/v1/reports/summary/monthly', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (resMonthly.ok) {
                    const response = await resMonthly.json();
                    const data = response.data;
                    document.getElementById('monthlyCollected').textContent = `‚Ç¶${data.collected.toLocaleString()}`;
                    document.getElementById('monthlyPending').textContent = `‚Ç¶${data.pending.toLocaleString()}`;
                } // Annual Stats
                const resAnnual = await fetch('/api/v1/reports/summary/annual', {
                    headers: { 'Authorization': `Bearer ${token}` }
                }); if (resAnnual.ok) {
                    const response = await resAnnual.json();
                    const data = response.data;
                    document.getElementById('annualTotal').textContent = `‚Ç¶${data.total.toLocaleString()}`;
                    document.getElementById('annualExpenses').textContent = `‚Ç¶${data.expenses.toLocaleString()}`;
                    document.getElementById('balance').textContent = `‚Ç¶${data.balance.toLocaleString()}`;
                }

                // Overview Stats
                const resOverview = await fetch('/api/v1/admin/overview', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (resOverview.ok) {
                    const result = await resOverview.json();
                    const data = result.data || {};
                    document.getElementById('unreadMessages').textContent = data.unreadMessages;
                    document.getElementById('pendingWelfare').textContent = data.pendingWelfare;
                    document.getElementById('upcomingEvents').textContent = data.upcomingEvents;

                    // Populate Recent Welfare
                    const welfareList = document.getElementById('recentWelfareList');
                    if (data.recentWelfare.length > 0) {
                        welfareList.innerHTML = data.recentWelfare.map(w => `
                    <div class="p-4 hover:bg-gray-50 transition">
                                <div class="flex justify-between items-start mb-1">
                                    <p class="text-sm font-bold text-gray-900">${w.user_name}</p>
                                    <span class="text-[9px] font-black uppercase px-2 py-0.5 rounded bg-gray-100 text-gray-500">${w.status}</span>
                                </div>
                                <p class="text-[10px] text-gray-500 font-medium">${w.type} ‚Ä¢ ‚Ç¶${w.amount.toLocaleString()}</p>
                            </div>
                        `).join('');
                    } else {
                        welfareList.innerHTML = '<div class="p-6 text-center text-gray-400 text-xs font-medium">No recent requests</div>';
                    }

                    // Populate Recent Expenses
                    const expenseList = document.getElementById('recentExpensesList');
                    if (data.recentExpenses.length > 0) {
                        expenseList.innerHTML = data.recentExpenses.map(e => `
                            <div class="p-4 hover:bg-gray-50 transition">
                                <div class="flex justify-between items-start mb-1">
                                    <p class="text-sm font-bold text-gray-900">${e.reason}</p>
                                    <p class="text-xs font-black text-red-600 font-mono">‚Ç¶${e.amount.toLocaleString()}</p>
                                </div>
                                <p class="text-[10px] text-gray-500 font-medium">${new Date(e.date).toLocaleDateString()} ‚Ä¢ ${e.category}</p>
                            </div>
                            `).join('');
                    } else {
                        expenseList.innerHTML = '<div class="p-6 text-center text-gray-400 text-xs font-medium">No recent expenses</div>';
                    }

                    // Populate Upcoming Events
                    const eventList = document.getElementById('upcomingEventsList');
                    if (data.upcomingEventsList.length > 0) {
                        eventList.innerHTML = data.upcomingEventsList.map(ev => `
                            <div class="p-4 hover:bg-gray-50 transition">
                                <div class="flex justify-between items-start mb-1">
                                    <p class="text-sm font-bold text-gray-900">${ev.title}</p>
                                    <span class="text-[9px] font-black uppercase px-2 py-0.5 rounded bg-blue-100 text-blue-700">Upcoming</span>
                                </div>
                                <p class="text-[10px] text-gray-500 font-medium">${new Date(ev.date).toLocaleDateString()} @ ${ev.time || 'N/A'}</p>
                            </div>
                            `).join('');
                    } else {
                        eventList.innerHTML = '<div class="p-6 text-center text-gray-400 text-xs font-medium">No upcoming events</div>';
                    }
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function fetchAdminDetails() {
            const token = localStorage.getItem('access_token');
            if (!token) return;

            try {
                const res = await fetch('/api/v1/admin/members', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (res.ok) {
                    const result = await res.json();
                    const members = result.data || [];

                    // Basic JWT decode to find current user
                    if (token.split('.').length < 2) return;

                    const base64Url = token.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));

                    const decoded = JSON.parse(jsonPayload);
                    const admin = members.find(m => m._id === decoded.id);

                    if (admin) {
                        document.getElementById('sidebarAdminName').textContent = admin.full_name;
                        document.getElementById('sidebarAdminRole').textContent = admin.role.toUpperCase();
                    }
                }
            } catch (e) {
                console.error(e);
            }
        }

        function exportToCSV() {
            if (!allMembers.length) {
                alert("No members to export!");
                return;
            }

            // CSV Header
            const headers = ["Name", "Email", "Role", "Status", "Score", "Phone"];

            // CSV Rows
            const rows = allMembers.map(m => [
                `"${m.full_name}"`,
                `"${m.email}"`,
                m.role,
                m.is_active ? "Active" : "Inactive",
                m.contribution_score || 0,
                m.phone || ""
            ]);

            // Combine
            const csvContent = [
                headers.join(","),
                ...rows.map(r => r.join(","))
            ].join("\n");

            // Create download link
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "members_export.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function triggerMonthly() {
            if (!confirm("Generate monthly dues for all active members (‚Ç¶1,000 each)?")) return;
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch('/api/v1/contributions/generate-monthly', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    alert("Monthly dues generated successfully!");
                    fetchStats();
                }
            } catch (e) { console.error(e); }
        }

        async function sendReminders() {
            if (!confirm("Send contribution reminders to all members with pending payments?")) return;
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch('/api/v1/admin/trigger-reminders', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const result = await res.json();
                    alert(result.message);
                }
            } catch (e) { console.error(e); }
        }

        // Edit Role Modal Functions
        let currentEditUserId = null;

        function openEditModal(userId, currentRole, fullName) {
            currentEditUserId = userId;
            document.getElementById('editMemberName').textContent = fullName;
            document.getElementById('editRoleSelect').value = currentRole;
            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editModal').classList.add('flex');
        }

        function closeEditModal() {
            currentEditUserId = null;
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editModal').classList.remove('flex');
        }

        async function saveRoleChange() {
            if (!currentEditUserId) return;

            const newRole = document.getElementById('editRoleSelect').value;
            const token = localStorage.getItem('access_token');

            try {
                const res = await fetch(`/api/v1/admin/members/${currentEditUserId}/role`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ role: newRole })
                });

                if (res.ok) {
                    const result = await res.json();
                    alert(result.message || 'Role updated successfully!');
                    closeEditModal();
                    fetchMembers(); // Refresh the table
                } else {
                    const error = await res.json();
                    alert(error.detail || 'Failed to update role');
                }
            } catch (e) {
                console.error(e);
                alert('An error occurred while updating the role');
            }
        }

        // Add Member Modal Functions
        function openAddMemberModal() {
            document.getElementById('addMemberModal').classList.remove('hidden');
            document.getElementById('addMemberModal').classList.add('flex');
        }

        function closeAddMemberModal() {
            document.getElementById('addMemberModal').classList.add('hidden');
            document.getElementById('addMemberModal').classList.remove('flex');
            document.getElementById('addMemberForm').reset();
        }

        async function submitAddMember(e) {
            e.preventDefault();
            const token = localStorage.getItem('access_token');

            const formData = {
                full_name: document.getElementById('addFullName').value,
                username: document.getElementById('addUsername').value,
                email: document.getElementById('addEmail').value,
                phone: document.getElementById('addPhone').value,
                password: document.getElementById('addPassword').value
            };

            try {
                const res = await fetch('/api/v1/admin/members', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const text = await res.text();

                if (res.ok) {
                    try {
                        const result = JSON.parse(text);
                        alert(result.message);
                        closeAddMemberModal();
                        fetchMembers(); // Refresh the table
                    } catch (e) {
                        alert('Success, but failed to parse response.');
                        closeAddMemberModal();
                        fetchMembers();
                    }
                } else {
                    try {
                        const error = JSON.parse(text);
                        alert(error.detail || 'Failed to add member');
                    } catch (err) {
                        console.error('Non-JSON error:', text);
                        alert(`Request failed with status ${res.status}: ${text.substring(0, 100)} `);
                    }
                }
            } catch (e) {
                console.error(e);
                alert(`Error: ${e.message} `);
            }
        }

        // === PENDING APPROVALS FUNCTIONS ===
        async function fetchPendingUsers() {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch('/api/v1/admin/pending-users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const result = await res.json();
                    const pendingUsers = result.data || [];
                    document.getElementById('pendingApprovals').textContent = pendingUsers.length;

                    const pendingSection = document.getElementById('pendingSection');
                    const pendingBadge = document.getElementById('pendingBadge');

                    if (pendingUsers.length > 0) {
                        pendingSection.classList.remove('hidden');
                        pendingBadge.textContent = `${pendingUsers.length} pending`;

                        const tbody = document.getElementById('pendingTable');
                        tbody.innerHTML = pendingUsers.map(u => {
                            const date = new Date(u.created_at).toLocaleDateString();
                            return `
                            <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${u.full_name}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${u.email}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${u.username || '-'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${u.phone || '-'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${date}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right">
                <button onclick="approveUser('${u._id}', '${u.full_name}')"
                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold transition transform active:scale-95 shadow">
                    ‚úì Approve
                </button>
            </td>
        </tr>
                            `;
                        }).join('');
                    } else {
                        pendingSection.classList.add('hidden');
                    }
                }
            } catch (e) { console.error(e); }
        }

        async function approveUser(userId, fullName) {
            if (!confirm(`Approve ${fullName}? They will be able to log in after approval.`)) return;

            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`/api/v1/admin/users/${userId}/approve`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ role: 'Member' })
                });

                if (res.ok) {
                    alert(`${fullName} has been approved successfully!`);
                    fetchPendingUsers(); // Refresh pending list
                    fetchMembers(); // Refresh members list
                } else {
                    const error = await res.json();
                    alert(error.detail || error.error || 'Failed to approve member');
                }
            } catch (e) {
                console.error(e);
                alert('An error occurred while approving');
            }
        }

        fetchMembers();
        fetchStats();
        fetchPendingUsers();
        fetchAdminDetails();
    </script>
</body>

</html>